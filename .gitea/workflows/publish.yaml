name: å‘å¸ƒ VS Code æ‰©å±• (Production)
run-name: ${{ gitea.actor }} å‘å¸ƒ MCP-Diagnostics v${{ inputs.version || 'è‡ªåŠ¨æ£€æµ‹' }} ðŸš€

on:
  push:
    branches: [main, master]
    paths: ["package.json"]
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      version:
        description: "å¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬å· (å¯é€‰)"
        required: false
        type: string

env:
  # ç»Ÿä¸€ç®¡ç†é…ç½®
  GITEA_URL: "http://192.168.192.1:3000"
  REGISTRY: "https://registry.npmmirror.com"
  EXT_NAME: "mcp-diagnostics"

jobs:
  publish:
    name: æž„å»ºå¹¶å‘å¸ƒ
    runs-on: bun
    steps:
      - name: ðŸ“‹ æ£€å‡ºä»£ç ä»“åº“
        uses: ${{ env.GITEA_URL }}/andy/checkout@main
        with:
          fetch-depth: 0 # å¿…é¡»ä¸º 0 æ‰èƒ½æ­£ç¡®å¯¹æ¯” git åŽ†å²

      - name: âš¡ ç¼“å­˜ Bun ä¾èµ–
        uses: ${{ env.GITEA_URL }}/fromsko/cache@main
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}

      - name: ðŸ“¦ çŽ¯å¢ƒå‡†å¤‡
        run: |
          npm config set registry ${{ env.REGISTRY }}
          bun install --frozen-lockfile
          # æ£€æŸ¥ vsce æ˜¯å¦å·²å®‰è£…ï¼Œæœªå®‰è£…åˆ™å®‰è£…
          command -v vsce >/dev/null 2>&1 || bun i -g vsce

      - name: ðŸ“„ ç‰ˆæœ¬å†³ç­–ä¸­å¿ƒ
        id: version_logic
        run: |
          # 1. èŽ·å–å½“å‰ç‰ˆæœ¬
          CUR_V=$(node -p "require('./package.json').version")

          # 2. åˆ¤æ–­æ˜¯å¦è·³è¿‡
          SKIP=false
          if [ "${{ gitea.event_name }}" = "push" ] && [ -z "${{ gitea.ref_tag }}" ]; then
            PREV_V=$(git show HEAD~1:package.json | node -p "require('fs').readFileSync(0).toString(), JSON.parse(stdin).version" 2>/dev/null || echo "unknown")
            if [ "$CUR_V" = "$PREV_V" ]; then SKIP=true; fi
          fi

          echo "version=$CUR_V" >> $GITHUB_OUTPUT
          echo "skip=$SKIP" >> $GITHUB_OUTPUT
          echo "V_TAG=v$CUR_V" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ ç”Ÿäº§çŽ¯å¢ƒæ‰“åŒ…
        if: steps.version_logic.outputs.skip != 'true'
        run: |
          # ä½¿ç”¨ç”Ÿäº§æž„å»ºå‘½ä»¤
          bun run compile
          vsce package
          # åŠ¨æ€é‡å‘½åæ£€æµ‹ (é˜²æ­¢ç‰ˆæœ¬å·ä¸ä¸€è‡´)
          VSIX_FILE="${{ env.EXT_NAME }}-${{ steps.version_logic.outputs.version }}.vsix"
          if [ ! -f "$VSIX_FILE" ]; then
             echo "âŒ æ‰¾ä¸åˆ° $VSIX_FILEï¼Œå°è¯•æŸ¥æ‰¾å½“å‰ç›®å½• vsix"
             VSIX_FILE=$(ls *.vsix | head -n 1)
          fi
          echo "FINAL_VSIX=$VSIX_FILE" >> $GITHUB_ENV

      - name: ðŸ·ï¸ è‡ªåŠ¨ç»´æŠ¤ Git æ ‡ç­¾
        if: steps.version_logic.outputs.skip != 'true'
        run: |
          TAG="${{ steps.version_logic.outputs.V_TAG }}"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            git config user.name "Gitea Actions"
            git config user.email "actions@gitea.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
          fi

      - name: ðŸ“¦ åŒæ­¥è‡³ VS Code Marketplace
        if: steps.version_logic.outputs.skip != 'true'
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          # å¢žåŠ éªŒè¯æ­¥éª¤
          if [ -z "$VSCE_PAT" ]; then
            echo "âŒ ç¼ºå°‘ VSCE_PAT å¯†é’¥ï¼Œè·³è¿‡å¸‚åœºå‘å¸ƒ"
          else
            vsce publish -p $VSCE_PAT --packagePath ${{ env.FINAL_VSIX }}
          fi

      - name: ðŸš€ åˆ›å»º Gitea Release
        if: steps.version_logic.outputs.skip != 'true'
        uses: ${{ env.GITEA_URL }}/fromsko/gitea-release-action@v1
        with:
          token: ${{ secrets.GITEA_TOKEN }}
          tag_name: ${{ steps.version_logic.outputs.V_TAG }}
          name: "MCP-Diagnostics ${{ steps.version_logic.outputs.V_TAG }}"
          body: |
            ## ðŸŽ‰ MCP-Diagnostics ${{ steps.version_logic.outputs.V_TAG }} å‘å¸ƒ

            ### ðŸ“ æäº¤æ‘˜è¦
            $(git log -10 --pretty=format:"- %s (%h)")

            ---
            æž„å»ºæ—¶é—´: ${{ env.BUILD_TIME }}
          files: |
            ${{ env.FINAL_VSIX }}
          md5sum: true
          sha256sum: true

      - name: ðŸŽ¯ çŠ¶æ€æ±‡æ€»
        if: always()
        run: |
          echo "### æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "- ç‰ˆæœ¬: ${{ steps.version_logic.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- çŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- è·³è¿‡å‘å¸ƒ: ${{ steps.version_logic.outputs.skip }}" >> $GITHUB_STEP_SUMMARY
